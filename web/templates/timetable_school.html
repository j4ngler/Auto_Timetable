{% extends 'base.html' %}
{% block title %}Thời khoá biểu (Toàn trường){% endblock %}
{% block page_title %}Thời khoá biểu (Toàn trường){% endblock %}
{% block content %}
<section class="panel" style="display:grid; gap:12px;">
  <div class="actions">
    <a class="btn" href="/run/schedule" onclick="event.preventDefault(); run();">Chạy sắp xếp</a>
    <a class="btn secondary" href="/preview?file=schedule_final.csv">Xem kết quả</a>
  </div>

  <div>
    <label>Job ID</label>
    <div style="display:flex; gap:8px;">
      <input id="jobId" placeholder="Dán job_id hoặc bấm Chạy sắp xếp" />
      <button class="btn secondary" id="btnPoll">Poll</button>
    </div>
  </div>

  <div id="jobStatus" style="background:var(--panel); padding:12px; max-height:400px; overflow:auto;"></div>

  <div class="table-container" style="margin-top:12px;">
    <table>
      <thead>
        <tr>
          <th>ClassID</th><th>CourseID</th><th>SubjectName</th><th>TimeSlot</th><th>Room</th>
        </tr>
      </thead>
      <tbody id="rows"></tbody>
    </table>
  </div>
</section>

<script>
// Hàm hỗ trợ API
async function post(url) { const r = await fetch(url, {method:'POST'}); return r.json(); }
async function get(url) { const r = await fetch(url); return r.json(); }

// Hàm format job status
function formatJobStatus(job) {
  if (!job) return '<p style="color:var(--muted);">Đang tải...</p>';
  const status = job.status || 'unknown';
  const statusColors = {'running': '#3b82f6', 'completed': '#10b981', 'failed': '#ef4444', 'unknown': '#6b7280'};
  const statusTexts = {'running': 'Đang chạy', 'completed': 'Hoàn thành', 'failed': 'Thất bại', 'unknown': 'Không xác định'};
  let html = `<div style="display:grid; gap:12px;"><div style="display:flex; align-items:center; gap:8px; padding:8px; background:var(--bg); border-radius:6px;"><div style="width:12px; height:12px; border-radius:50%; background:${statusColors[status] || statusColors.unknown};"></div><strong>Trạng thái:</strong> <span style="color:${statusColors[status] || statusColors.unknown};">${statusTexts[status] || status}</span></div>`;
  if (job.title) html += `<div><strong>Tiêu đề:</strong> ${job.title}</div>`;
  if (job.created_at) { const date = new Date(job.created_at); html += `<div><strong>Thời gian tạo:</strong> ${date.toLocaleString('vi-VN')}</div>`; }
  if (job.logs && job.logs.length > 0) {
    html += `<div style="margin-top:8px;"><strong>Thông báo:</strong></div><table style="width:100%; border-collapse:collapse; margin-top:8px;"><thead><tr style="background:var(--bg); border-bottom:1px solid var(--border);"><th style="padding:8px; text-align:left; width:100px;">Loại</th><th style="padding:8px; text-align:left;">Nội dung</th></tr></thead><tbody>`;
    const successLogs = [], errorLogs = [], warningLogs = [], infoLogs = [];
    job.logs.forEach(log => {
      const logStr = String(log);
      if (logStr.includes('[SUCCESS]')) successLogs.push(logStr.replace(/\[SUCCESS\]/g, '').trim());
      else if (logStr.includes('[ERROR]')) errorLogs.push(logStr.replace(/\[ERROR\]/g, '').trim());
      else if (logStr.includes('[WARNING]')) warningLogs.push(logStr.replace(/\[WARNING\]/g, '').trim());
      else if (logStr.includes('[INFO]')) infoLogs.push(logStr.replace(/\[INFO\]/g, '').trim());
      else if (logStr.trim()) infoLogs.push(logStr.trim());
    });
    successLogs.forEach(msg => html += `<tr><td style="padding:6px 8px; color:#10b981; font-weight:600;">Thành công</td><td style="padding:6px 8px;">${msg}</td></tr>`);
    warningLogs.forEach(msg => html += `<tr><td style="padding:6px 8px; color:#f59e0b; font-weight:600;">Cảnh báo</td><td style="padding:6px 8px;">${msg}</td></tr>`);
    errorLogs.forEach(msg => html += `<tr><td style="padding:6px 8px; color:#ef4444; font-weight:600;">Lỗi</td><td style="padding:6px 8px;">${msg}</td></tr>`);
    infoLogs.forEach(msg => { if (msg) html += `<tr><td style="padding:6px 8px; color:var(--muted);">Thông tin</td><td style="padding:6px 8px;">${msg}</td></tr>`; });
    html += `</tbody></table>`;
  }
  if (job.error) html += `<div style="margin-top:12px; padding:12px; background:#fee2e2; border:1px solid #fecaca; border-radius:6px; color:#991b1b;"><strong>Lỗi:</strong> ${job.error}</div>`;
  if (job.result && job.result.returncode !== undefined) {
    const codeColor = job.result.returncode === 0 ? '#10b981' : '#ef4444';
    html += `<div style="margin-top:8px;"><strong>Mã trả về:</strong> <span style="color:${codeColor};">${job.result.returncode}</span></div>`;
  }
  html += `</div>`;
  return html;
}

// Hàm poll job status
async function poll(id){
  const box = document.getElementById('jobStatus');
  box.innerHTML='<p style="color:var(--muted);">Đang kiểm tra...</p>';
  let stop=false; while(!stop){
    const s = await get(`/status/${id}`);
    box.innerHTML = formatJobStatus(s);
    if(s.status==='completed' || s.status==='failed') {
      stop=true;
      // Tự động reload bảng khi job hoàn thành
      if(s.status==='completed') {
        load();
      }
    } else {
      await new Promise(r=>setTimeout(r,1500));
    }
  }
}

// Hàm chạy schedule
async function run(){
  const res = await post('/run/schedule');
  document.getElementById('jobId').value = res.job_id;
  await poll(res.job_id);
}

// Event listener cho nút Poll
document.getElementById('btnPoll').addEventListener('click', async()=>{
  const id = document.getElementById('jobId').value.trim();
  if(id) await poll(id);
});

// Chuẩn hóa giờ học thành hh:mm
function normalizeTime(timeStr) {
  if (!timeStr) return timeStr;
  if (timeStr.includes(':')) return timeStr;
  if (timeStr.includes('-')) {
    const parts = timeStr.split('-');
    return parts.map(p => {
      p = p.trim();
      if (p.length === 4) {
        return p.substring(0, 2) + ':' + p.substring(2);
      }
      return p;
    }).join('-');
  }
  if (timeStr.length === 4 && /^\d{4}$/.test(timeStr)) {
    return timeStr.substring(0, 2) + ':' + timeStr.substring(2);
  }
  return timeStr;
}

// Hàm load bảng thời khóa biểu
async function load(){
  const res = await fetch('/download?file=schedule_final.csv');
  const text = await res.text();
  const lines = text.split(/\r?\n/).filter(Boolean);
  const body = document.getElementById('rows');
  body.innerHTML = ''; // Clear trước khi load lại
  const cols = lines[0].split(',');
  const map = {
    ClassID: cols.indexOf('ClassID'), CourseID: cols.indexOf('CourseID'), SubjectName: cols.indexOf('SubjectName'),
    TimeSlot: cols.indexOf('TimeSlot'), RoomAssigned: cols.indexOf('RoomAssigned')
  };
  for(let i=1;i<lines.length;i++){
    const c = lines[i].split(',');
    const timeSlot = normalizeTime((c[map.TimeSlot]||'').trim());
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${c[map.ClassID]||''}</td><td>${c[map.CourseID]||''}</td><td>${c[map.SubjectName]||''}</td><td>${timeSlot}</td><td>${c[map.RoomAssigned]||''}</td>`;
    body.appendChild(tr);
  }
}

// Load bảng khi trang được tải
load();
</script>
{% endblock %}


